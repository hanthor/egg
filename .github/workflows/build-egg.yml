name: Build Bluefin Egg

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: egg
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  BST2_IMAGE: registry.gitlab.com/freedesktop-sdk/infrastructure/freedesktop-sdk-docker-images/bst2:f89b4aef847ef040b345acceda15a850219eb8f1
  CACHE_GRPC_PORT: 9092
  CACHE_HTTP_PORT: 8080

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.ref || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  planning:
    runs-on: ubuntu-24.04
    outputs:
      chunk1: ${{ steps.matrix.outputs.chunk1 }}
      chunk2: ${{ steps.matrix.outputs.chunk2 }}
      chunk3: ${{ steps.matrix.outputs.chunk3 }}
      chunk4: ${{ steps.matrix.outputs.chunk4 }}
      chunk5: ${{ steps.matrix.outputs.chunk5 }}
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Pull BuildStream container image
        run: podman pull "$BST2_IMAGE"

      - name: Generate BuildStream CI config
        run: ./scripts/setup-buildstream.sh

      - name: Generate Build Matrix
        id: matrix
        run: |
          mkdir -p logs
          # Run the script inside container to ensure python/bst environment matches
          podman run --rm \
            -v "${{ github.workspace }}:/src:rw" \
            -v "$HOME/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src \
            "$BST2_IMAGE" \
            python3 scripts/generate-build-matrix.py oci/bluefin.bst 5 > matrix.json

          cat matrix.json
          python3 -c "import json, sys; data = json.load(open('matrix.json')); [print(f'{k}={v}') for k,v in data.items()]" >> "$GITHUB_OUTPUT"

      - name: Upload planning logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: planning-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  build:
    needs: planning
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        chunk: [chunk1, chunk2, chunk3, chunk4, chunk5]
    name: Build ${{ matrix.chunk }}
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - run: podman pull "$BST2_IMAGE"
      - run: ./scripts/setup-buildstream.sh

      - name: Build Chunk
        id: build
        env:
          TARGETS: ${{ needs.planning.outputs[matrix.chunk] }}
        run: |
          if [ -z "$TARGETS" ]; then
            echo "No targets for this chunk, skipping."
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p ~/.cache/buildstream
          podman run --rm --privileged --device /dev/fuse \
            -v "${{ github.workspace }}:/src:rw" \
            -v "$HOME/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src "$BST2_IMAGE" \
            bash -c "ulimit -n 1048576; bst --no-interactive --config buildstream-ci.conf --log-file logs/build-${{ matrix.chunk }}.log build $TARGETS"

      - name: Archive CAS
        if: steps.build.outputs.skipped != 'true'
        run: |
          # We archive the CAS and artifacts metadata.
          # This is heavyIO but allows moving the state.
          echo "Archiving CAS..."
          du -sh ~/.cache/buildstream
          tar -cf cas-${{ matrix.chunk }}.tar -C "$HOME/.cache/buildstream" cas artifacts source_protos

      - name: Upload CAS Artifact
        if: steps.build.outputs.skipped != 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: cas-${{ matrix.chunk }}
          path: cas-${{ matrix.chunk }}.tar
          retention-days: 1
          if-no-files-found: ignore

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: build-logs-${{ matrix.chunk }}
          path: logs/
          retention-days: 7

  export:
    needs: [planning, build]
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - run: podman pull "$BST2_IMAGE"
      - run: ./scripts/setup-buildstream.sh

      - name: Download all CAS chunks
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          pattern: cas-*
          path: downloaded-cas
          merge-multiple: true

      - name: Merge CAS
        run: |
          mkdir -p ~/.cache/buildstream
          echo "Merging CAS chunks..."
          find downloaded-cas -name "cas-*.tar" -print0 | xargs -0 -I {} tar -xf {} -C "$HOME/.cache/buildstream"
          echo "CAS merge complete."
          du -sh ~/.cache/buildstream

      # Ensure everything is pulled/built/merged before export
      # The final build should be very fast as everything is in CAS
      - name: Export OCI image from BuildStream
        id: export
        run: |
          LOADED=$(podman run --rm --privileged --device /dev/fuse \
            -v "${{ github.workspace }}:/src:rw" \
            -v "$HOME/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src "$BST2_IMAGE" \
            bash -c 'ulimit -n 1048576; bst --no-interactive --config buildstream-ci.conf artifact checkout --tar - oci/bluefin.bst' | podman load)
          IMAGE_REF=$(echo "$LOADED" | grep -oP '(?<=Loaded image: ).*' || echo "$LOADED" | grep -oP '(?<=Loaded image\(s\): ).*')
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "Loaded: $IMAGE_REF"

      - name: Verify image loaded
        run: podman images

      - name: Validate with bootc container lint
        run: |
          podman run --rm --privileged \
            -v /var/lib/containers:/var/lib/containers \
            "${{ steps.export.outputs.image_ref }}" \
            bootc container lint

      - name: Upload export logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: export-logs
          path: logs/
          retention-days: 7

      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Tag image for GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          podman tag "${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Push to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          podman push --retry 3 "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          podman push --retry 3 "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
