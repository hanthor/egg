name: Build Bluefin Egg

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: egg
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  BST2_IMAGE: registry.gitlab.com/freedesktop-sdk/infrastructure/freedesktop-sdk-docker-images/bst2:f89b4aef847ef040b345acceda15a850219eb8f1
  R2_BUCKET: bst-cache

# On PRs: group by branch so new pushes cancel stale runs.
# On main: group by SHA so every push gets its own non-cancellable run.
# (GitHub cancels even pending/queued runs in the same group regardless of
#  cancel-in-progress when a newer run arrives, so main needs unique groups.)
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.ref || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# ═══════════════════════════════════════════════════════════════════════
# Build Pipeline Architecture
# ═══════════════════════════════════════════════════════════════════════
#
# The gnomeos base layer is the heaviest part of the build. Both
# junctions (freedesktop-sdk, gnome-build-meta) are patched so nothing
# hits the upstream GNOME CAS cache -- everything is built from source.
#
# To avoid overwhelming a single free GitHub runner (6h timeout, ~50GB
# disk after cleanup), the gnomeos build is split into a sequential
# chain of jobs. Each job builds one tier of the dependency tree, pushes
# artifacts to R2, and the next job pulls them as cached:
#
#   Tier 1: warmup-sdk      ─── freedesktop-sdk platform + GNOME SDK
#           │                    (GCC, glibc, mesa, systemd, GTK4,
#           │                     WebKit, GStreamer, ~hundreds of libs)
#           ▼
#   Tier 2: warmup-desktop  ─── GNOME desktop shell
#           │                    (mutter, gnome-shell, GDM, nautilus,
#           │                     gnome-control-center, ptyxis, etc.)
#           ▼
#   Tier 3: warmup-gnomeos  ─── GNOME OS image assembly
#           │                    (Linux kernel, initramfs, bootc,
#           │                     firmware, signed modules, OCI layer)
#           ▼
#   Tier 4: build           ─── Final Bluefin OCI image
#                                (bluefin layer + gnomeos parent)
#
#   Independent (parallel with all tiers):
#           warmup-ghostty  ─── Zig compile + 35 deps
#
# Each tier only builds incremental work on top of the previous tier's
# cached artifacts, so no single runner needs to build the full stack.
# ═══════════════════════════════════════════════════════════════════════

jobs:
  # ── TIER 1: SDK Platform ──────────────────────────────────────────────
  # Build the entire freedesktop-sdk platform + GNOME SDK libraries.
  # This is the foundation everything else depends on. Contains GCC,
  # glibc, mesa, systemd, GTK4, WebKit, GStreamer, librsvg, mozjs, etc.
  #
  # This is typically the heaviest single tier since freedesktop-sdk is
  # patched (kernel config, openssh, lvm2) causing full rebuilds.
  warmup-sdk:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup BuildStream CI environment
        uses: ./.github/actions/setup-bst
        with:
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}

      - name: Build and sync SDK platform
        uses: ./.github/actions/bst-build-tier
        with:
          target: gnome-build-meta.bst:sdk-platform.bst
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}
          artifact-name: buildstream-logs-warmup-sdk

  # ── TIER 2: GNOME Desktop Shell ───────────────────────────────────────
  # Build the GNOME desktop components: mutter, gnome-shell, GDM,
  # gnome-control-center, nautilus, ptyxis, and all core OS services.
  # Pulls SDK platform artifacts from R2 (built by tier 1).
  warmup-desktop:
    needs: warmup-sdk
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup BuildStream CI environment
        uses: ./.github/actions/setup-bst
        with:
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}

      - name: Build and sync GNOME desktop
        uses: ./.github/actions/bst-build-tier
        with:
          target: gnome-build-meta.bst:gnomeos-deps/deps.bst
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}
          artifact-name: buildstream-logs-warmup-desktop

  # ── TIER 3: GNOME OS Image ───────────────────────────────────────────
  # Build the full GNOME OS OCI parent image: Linux kernel, initramfs,
  # bootc, firmware, signed modules, and OCI layer assembly.
  # Pulls desktop artifacts from R2 (built by tiers 1+2).
  warmup-gnomeos:
    needs: warmup-desktop
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup BuildStream CI environment
        uses: ./.github/actions/setup-bst
        with:
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}

      - name: Build and sync GNOME OS image
        uses: ./.github/actions/bst-build-tier
        with:
          target: oci/gnomeos.bst
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}
          artifact-name: buildstream-logs-warmup-gnomeos

  # ── INDEPENDENT: Ghostty ──────────────────────────────────────────────
  # Zig compile + 35 deps. Independent of gnomeos -- runs in parallel
  # with all tiers above.
  warmup-ghostty:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup BuildStream CI environment
        uses: ./.github/actions/setup-bst
        with:
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}

      - name: Build and sync Ghostty
        uses: ./.github/actions/bst-build-tier
        with:
          target: bluefin/ghostty.bst
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}
          artifact-name: buildstream-logs-warmup-ghostty

  # ── TIER 4: FINAL ASSEMBLY ───────────────────────────────────────────
  # Once all warmup tiers have built and pushed their artifacts, this job
  # starts fresh, pulls everything from R2 (fast download, not rebuild),
  # and finishes the Bluefin OCI image assembly.
  build:
    needs: [warmup-gnomeos, warmup-ghostty]
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup BuildStream CI environment
        uses: ./.github/actions/setup-bst
        with:
          bst2-image: ${{ env.BST2_IMAGE }}
          r2-access-key: ${{ secrets.R2_ACCESS_KEY }}
          r2-secret-key: ${{ secrets.R2_SECRET_KEY }}
          r2-endpoint: ${{ secrets.R2_ENDPOINT }}
          r2-bucket: ${{ env.R2_BUCKET }}

      # ── Background R2 sync ──────────────────────────────────────────
      # Start a background loop that pushes new CAS blobs to R2 every
      # 2 minutes while the build runs. This ensures the R2 cache is
      # filled incrementally even if the build times out or is cancelled.
      # The loop runs on the host (not in the container) and has direct
      # access to ~/.cache/buildstream/ via the bind mount.

      - name: Start background R2 sync
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          if [ -z "${R2_ACCESS_KEY}" ]; then
            echo "R2 secrets not configured, skipping background sync"
            exit 0
          fi

          BST_CACHE="$HOME/.cache/buildstream"

          cat > /tmp/r2-sync-loop.sh <<'SYNCSCRIPT'
          #!/usr/bin/env bash
          set -euo pipefail
          BST_CACHE="$1"
          R2_BUCKET="$2"
          INTERVAL=120  # seconds between sync cycles

          echo "[r2-sync] Background sync started (every ${INTERVAL}s)"
          while true; do
            sleep "$INTERVAL"
            echo "[r2-sync] $(date -Iseconds) Starting sync cycle..."

            # CAS: copy only (never delete), skip existing (immutable blobs)
            rclone copy "${BST_CACHE}/cas/" "r2:${R2_BUCKET}/cas/" \
              --ignore-existing \
              --transfers=16 \
              --checkers=32 \
              --fast-list \
              --stats=0 \
              -q 2>&1 | sed 's/^/[r2-sync] /' || echo "[r2-sync] CAS sync warning (non-fatal)"

            # Artifact refs: sync (metadata can change)
            rclone sync "${BST_CACHE}/artifacts/" "r2:${R2_BUCKET}/artifacts/" \
              --transfers=8 \
              --checkers=16 \
              --fast-list \
              --stats=0 \
              -q 2>&1 | sed 's/^/[r2-sync] /' || echo "[r2-sync] Artifacts sync warning (non-fatal)"

            # Source protos: sync (metadata can change)
            rclone sync "${BST_CACHE}/source_protos/" "r2:${R2_BUCKET}/source_protos/" \
              --transfers=8 \
              --checkers=16 \
              --fast-list \
              --stats=0 \
              -q 2>&1 | sed 's/^/[r2-sync] /' || echo "[r2-sync] Source protos sync warning (non-fatal)"

            echo "[r2-sync] $(date -Iseconds) Sync cycle complete"
          done
          SYNCSCRIPT
          chmod +x /tmp/r2-sync-loop.sh

          nohup /tmp/r2-sync-loop.sh "$BST_CACHE" "$R2_BUCKET" \
            > /tmp/r2-sync-loop.log 2>&1 &
          echo $! > /tmp/r2-sync-loop.pid
          echo "Background R2 sync started (PID $(cat /tmp/r2-sync-loop.pid))"

      # ── BuildStream build ─────────────────────────────────────────────
      # This build will be FAST because all heavy deps were already built
      # by the warmup chain:
      #   Tier 1: SDK platform (freedesktop-sdk + GNOME SDK)
      #   Tier 2: GNOME desktop (mutter, gnome-shell, deps)
      #   Tier 3: GNOME OS image (kernel, initramfs, bootc)
      #   Independent: Ghostty (Zig compile)
      # Their artifacts are in the R2 cache. BuildStream resolves them
      # as cached and skips rebuilding.
      # Runs inside the bst2 container with:
      # - --privileged: required for bubblewrap sandboxing
      # - --device /dev/fuse: required for buildbox-fuse (ext4 lacks reflinks)
      # - ulimit -n 1048576: buildbox-casd needs many file descriptors
      # - --no-interactive: prevent blocking on prompts in CI

      - name: Build OCI image with BuildStream
        run: |
          podman run --rm \
            --privileged \
            --device /dev/fuse \
            --network=host \
            -v "${{ github.workspace }}:/src:rw" \
            -v "$HOME/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src \
            "$BST2_IMAGE" \
            bash -c '
              ulimit -n 1048576 || true
              bst --no-interactive \
                  --colors \
                  --config /src/buildstream-ci.conf \
                  --log-file /src/logs/build.log \
                  build \
                  oci/bluefin.bst
            '
        timeout-minutes: 120

      # ── Final R2 sync ───────────────────────────────────────────────
      # Stop the background sync loop, then do one final thorough sync
      # to catch any blobs created since the last background cycle.
      # Always runs (even on build failure) so partial progress is saved.

      - name: Final sync to R2
        if: always()
        continue-on-error: true
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: |
          # Stop background sync loop
          if [ -f /tmp/r2-sync-loop.pid ]; then
            PID=$(cat /tmp/r2-sync-loop.pid)
            if kill -0 "$PID" 2>/dev/null; then
              echo "Stopping background R2 sync (PID $PID)"
              kill "$PID" || true
              wait "$PID" 2>/dev/null || true
            fi
            rm -f /tmp/r2-sync-loop.pid
          fi

          echo "=== Background sync log (last 30 lines) ==="
          tail -30 /tmp/r2-sync-loop.log 2>/dev/null || echo "(no log)"

          if [ -z "${R2_ACCESS_KEY}" ]; then
            echo "R2 secrets not configured, skipping final sync"
            exit 0
          fi

          BST_CACHE="$HOME/.cache/buildstream"

          echo "=== Local cache sizes ==="
          du -sh "${BST_CACHE}/cas" "${BST_CACHE}/artifacts" \
                 "${BST_CACHE}/source_protos" "${BST_CACHE}/sources" 2>/dev/null || true

          echo "=== Final CAS sync to R2 ==="
          rclone copy "${BST_CACHE}/cas/" "r2:${R2_BUCKET}/cas/" \
            --transfers=32 \
            --checkers=64 \
            --s3-upload-concurrency=4 \
            --s3-chunk-size=16M \
            --ignore-existing \
            --fast-list \
            --stats=10s \
            --stats-one-line \
            -v || echo "::warning::CAS sync to R2 failed"

          echo "=== Final artifact refs sync to R2 ==="
          rclone sync "${BST_CACHE}/artifacts/" "r2:${R2_BUCKET}/artifacts/" \
            --transfers=16 \
            --checkers=32 \
            --fast-list \
            -v || echo "::warning::Artifact refs sync to R2 failed"

          echo "=== Final source protos sync to R2 ==="
          rclone sync "${BST_CACHE}/source_protos/" "r2:${R2_BUCKET}/source_protos/" \
            --transfers=16 \
            --checkers=32 \
            --fast-list \
            -v || echo "::warning::Source protos sync to R2 failed"

          echo "=== R2 final sync complete ==="

      - name: Disk space after build
        if: always()
        run: df -h /

      # ── Export OCI image ──────────────────────────────────────────────
      # Stream the OCI tar from BuildStream directly into podman on the
      # host. This avoids writing an intermediate tar file to disk.
      # Pattern: bst artifact checkout --tar - | podman load

      - name: Export OCI image from BuildStream
        id: export
        run: |
          LOADED=$(podman run --rm \
            --privileged \
            --device /dev/fuse \
            -v "${{ github.workspace }}:/src:rw" \
            -v "$HOME/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src \
            "$BST2_IMAGE" \
            bash -c '
              ulimit -n 1048576 || true
              bst --no-interactive \
                  --config /src/buildstream-ci.conf \
                  artifact checkout --tar - oci/bluefin.bst
            ' | podman load)
          # podman load prints "Loaded image: <name>:<tag>" or "Loaded image(s): <id>"
          IMAGE_REF=$(echo "$LOADED" | grep -oP '(?<=Loaded image: ).*' || \
                      echo "$LOADED" | grep -oP '(?<=Loaded image\(s\): ).*')
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "Loaded: $IMAGE_REF"

      - name: Verify image loaded
        run: podman images

      # ── Validation ────────────────────────────────────────────────────

      - name: Validate with bootc container lint
        run: |
          podman run --rm --privileged \
            -v /var/lib/containers:/var/lib/containers \
            "${{ steps.export.outputs.image_ref }}" \
            bootc container lint

      # ── Upload build logs ─────────────────────────────────────────────
      # Always upload, even on failure, so build failures can be diagnosed.

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: buildstream-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # ── Publish to GHCR (main branch only) ───────────────────────────

      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Tag image for GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          podman tag "${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Push to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          podman push --retry 3 "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          podman push --retry 3 "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
